# 寸法測定機能の段階的ワークフロー - 修正版

## 修正概要
キャプチャとマーキングが同時実行される問題を解決するため、処理を段階的に分離しました。

## 新しいワークフロー

### 1. フレームキャプチャ段階
**ボタン**: 「フレームをキャプチャ」
**動作**:
- 動画の現在フレームを専用エリアにキャプチャ
- ズーム・パン機能のみ有効化
- 測定機能はまだ無効（クリックでのマーキングなし）
- 「測定開始」ボタンが有効化される

### 2. 測定開始段階
**ボタン**: 「測定開始」
**動作**:
- 寸法測定モードに切り替え
- クロスヘアカーソルに変更
- クリックでのマーキング機能を有効化
- 測定用UIを表示

### 3. リセット段階
**ボタン**: 「キャプチャリセット」
**動作**:
- すべての状態をリセット
- キャプチャエリアを非表示
- 最初の状態に戻る

## 修正されたUI構成

```html
<!-- 段階的なボタン配置 -->
<button id="captureFrameButton" disabled>フレームをキャプチャ</button>
<button id="startMeasurementButton" disabled>測定開始</button>
<button id="resetCaptureButton" disabled>キャプチャリセット</button>
```

## ボタンの状態遷移

| 段階 | フレームキャプチャ | 測定開始 | リセット |
|------|------------------|----------|----------|
| 初期状態 | ❌無効 | ❌無効 | ❌無効 |
| 動画ロード後 | ✅有効 | ❌無効 | ❌無効 |
| キャプチャ完了 | ❌無効(完了表示) | ✅有効 | ✅有効 |
| 測定開始後 | ❌無効 | ❌無効(測定中表示) | ✅有効 |

## 操作方法

### Step 1: 動画準備
1. 動画ファイルをアップロード
2. 測定したい場面で一時停止
3. 「フレームをキャプチャ」ボタンクリック

### Step 2: 画像調整（オプション）
- **ズーム**: マウスホイール
- **移動**: 右クリック+ドラッグ または Ctrl+左クリック+ドラッグ
- この段階では左クリックは無効（誤クリックを防止）

### Step 3: 測定開始
1. 参照オブジェクトのサイズを入力
2. 「測定開始」ボタンクリック
3. カーソルがクロスヘアに変更
4. 左クリックで測定点を設定

### Step 4: 測定実行
1. 参照オブジェクトの2点をクリック
2. 対象オブジェクトの2点をクリック
3. 結果が表示される

## 技術的な改善点

### 1. 責任の分離
- **キャプチャ処理**: フレームの取得と表示のみ
- **測定処理**: マーキングと計算のみ
- **状態管理**: 明確な段階区分

### 2. ユーザビリティ向上
- **誤操作防止**: 各段階でのみ必要な機能を有効化
- **明確な進行状況**: ボタンの状態でフローが分かる
- **いつでもリセット**: リセットボタンで最初から再開可能

### 3. デバッグ支援
- **段階別の状態表示**: どの段階にいるかが明確
- **詳細なデバッグ情報**: 座標変換や状態の可視化

## 修正されたファイル

1. **`src/test-dimension-measurement.html`**
   - UI構成の変更（3つのボタンに分離）
   - DOM要素宣言の追加
   - 段階的なイベントリスナー実装
   - デバッグ情報の強化

2. **`src/js/analysis/dimension.js`**
   - 既存の一体型処理を段階的処理に対応

## 期待される効果

1. **動作の安定性向上**: 処理が段階的になり、各段階で確実に動作
2. **デバッグの容易性**: 問題が発生した段階を特定しやすい
3. **ユーザー体験の向上**: 明確な操作フローで直感的な使用が可能

この修正により、キャプチャとマーキングが競合する問題が解決され、より確実な寸法測定が可能になります。
